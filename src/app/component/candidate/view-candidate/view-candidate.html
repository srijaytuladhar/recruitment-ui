<div class="container">
  <p-toast position="top-right"></p-toast>

  <button pButton label="Back" class="p-button-secondary" (click)="goBack()">
    <i class="pi pi-arrow-left"></i>
  </button>
  <div class="header flex align-items-center mb-4 justify-content-between">
    <div class="flex align-items-center">
      <h2 class="ml-3">{{ candidate?.name || 'Candidate Details' }}</h2> 
      <p-badge [value]="" severity="success" badgeSize="large" class="ml-2" *ngIf="candidate.status === 'ACTIVE'" pTooltip="Active User"/>
      <p-badge [value]="" severity="danger" badgeSize="large" class="ml-2" *ngIf="candidate.status !== 'ACTIVE'" pTooltip="Inactive User"/>
      <!-- <span *ngIf="candidate" [ngClass]="{
        'status-badge-active': candidate.status === 'ACTIVE',
        'status-badge-inactive': candidate.status !== 'ACTIVE'
      }" style="font-size: 12px;">{{ candidate.status }}</span> -->
    </div>
    <div class="resume-actions">
      <button pButton type="button" label="Download Resume" icon="pi pi-download" class="p-button-success" (click)="downloadResume()"></button>
      <button pButton type="button" label="View Resume" icon="pi pi-eye" class="p-button-info" (click)="viewResume()"></button>
    </div>
  </div>

  <ng-container *ngIf="candidate; else loading">

    <div class="card section-card mb-4">
      <h3 (click)="togglePersonalInformation()" class="collapsible-header">
        Personal Information
        <i class="pi" [ngClass]="{'pi-chevron-down': !showInformation, 'pi-chevron-up': showInformation}"></i>
      </h3>

      <div *ngIf="showInformation">
        <div class="form-row"><label>Email:</label><div class="value">{{ candidate.emailAddress }}</div></div>
        <div class="form-row"><label>Contact:</label><div class="value">{{ candidate.contactNumber }}</div></div>
        <div class="form-row"><label>Location:</label><div class="value">{{ candidate.currentAddress }}</div></div>
        <div class="form-row"><label>Job Location Desired:</label><div class="value">{{ candidate.jobLocationDesired }}</div></div>
        <div class="form-row"><label>Experience:</label><div class="value">{{ candidate.totalYearsOfExperience }} yrs</div></div>
        <div class="form-row"><label>Job Vertical:</label><div class="value">{{ candidate.jobVertical }}</div></div>
      </div>
    </div>

    <div *ngIf="candidate.education?.length" class="card section-card mb-4">
      <h3 (click)="toggleEducation()" class="collapsible-header">
        Education <i class="pi" [ngClass]="{'pi-chevron-down': !showEducation, 'pi-chevron-up': showEducation}"></i>
      </h3>
      <div *ngIf="showEducation">
        <div *ngFor="let edu of candidate.education" class="form-row">
          <label>{{ edu.degree }} in {{ edu.major }}</label>
          <div class="value">
            {{ edu.college }} ({{ edu.university }}) — GPA: {{ edu.gpa }} — Completed: {{ edu.completionDate | date:'MMM yyyy' }}
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="candidate.experience?.length" class="card section-card mb-4">
      <h3 (click)="toggleExperience()" class="collapsible-header">
        Work Experience <i class="pi" [ngClass]="{'pi-chevron-down': !showExperience, 'pi-chevron-up': showExperience}"></i>
      </h3>
      <div *ngIf="showExperience">
        <div *ngFor="let exp of candidate.experience" class="form-row">
          <label>{{ exp.role }} at {{ exp.companyName }}</label>
          <div class="value">
            {{ exp.location }} — {{ exp.startDate | date:'MMM yyyy' }} to {{ exp.current ? 'Present' : (exp.endDate | date:'MMM yyyy') }}<br/>
            {{ exp.description }}
          </div>
        </div>
      </div>
    </div>

    <p-button label="Proceed Further" [raised]="true" severity="success" (click)="navigateTo(candidate.id)">
    </p-button>
  </ng-container>

  <ng-template #loading>
    <p>Loading candidate details...</p>
  </ng-template>

  <!-- Resume Preview Dialog -->
  <p-dialog header="Resume Preview"
            [(visible)]="displayResumeModal"
            [modal]="true"
            [closable]="true"
            [resizable]="true"
            [draggable]="false"
            [style]="{ width: '95vw', maxWidth: '95vw', height: '95vh', maxHeight: '95vh', padding: '0' }"
            [contentStyle]="{ height: 'calc(95vh - 50px)', overflow: 'auto', padding: '0' }">
    <ng-container *ngIf="resumeSrc">
      <iframe *ngIf="resumeMimeType === 'application/pdf'" [src]="resumeSrc | safe" width="100%" height="100%" style="border:none;"></iframe>
      <img *ngIf="resumeMimeType.startsWith('image/')" [src]="resumeSrc" width="100%" style="height:100%; object-fit:contain; display:block; margin:auto;" />
    </ng-container>
  </p-dialog>
</div>
